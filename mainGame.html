<html>
<head>
	<style>
	canvas
	{
		position: absolute;
		top: 0px;
		left: 0px;
		z-index: -3;
	}
	</style>
</head>
<body onkeydown="keyBooleans()" onkeyup="keyBooleans()">
<div id="keyCodes"></div>
<button onclick="oneRightStep=true">One Right Step</button><button onclick="oneLeftStep=true">One Left Step</button><br>
<input type="number" id="initialVel" value="80">
<image src="Art/JesusL.png" style="display:none" id="JesusImgL">
<image src="Art/JesusLS.png" style="display:none" id="JesusImgLS">
<image src="Art/JesusR.png" style="display:none" id="JesusImgR">
<image src="Art/JesusRS.png" style="display:none" id="JesusImgRS">
<image src="Art/spaceBG.jpg" style="display:none" id="spaceBG">
<canvas id="canvas"></canvas>
<script src="js/colorFuns.js"></script>
<script src="js/drawnFunctions.js"></script>
<script src="js/canvasLibrary.js"></script>
<script>

var keys = new Array();
for(i=1;i<150;i++)
	keys[i] = false;
var leftPX = 0;
var topPX = 0;
var speed = 5;
var canvas = get("canvas");
var ctx = canvas.getContext("2d");
var jesusL = get("JesusImgL");
var jesusR = get("JesusImgR");
var jesusLS = get("JesusImgLS");
var jesusRS = get("JesusImgRS");
var spaceBG = get("spaceBG");
ctx.canvas.height = document.body.clientHeight;
ctx.canvas.width = document.body.clientWidth;
ctx.font = "14px Arial";

function get(id)
{
	return document.getElementById(id);
}

var direction = false;
// var dogLength = 200;
// var dogHeight = 126;
var state = "falling";
var plats = [];
var plat = new Platform(undefined, undefined, "Ground");
plats.push(plat);
plats.push(new Platform(0,200,"Platform"));
plats[1].pushFront(100,200);
var jumpFrame = 0;
var oneRightStep = false;
var oneLeftStep = false;
var jumpStart = 0;
var initialVel = 30;
var fallingFrame = 0;
var smoke = new Array();
var position = 0;

while(plat.front.x < document.body.clientWidth)
{
	plat.pushFrontRand();
}
plat.pushBackRand();
plat.pushBackRand();

function render()
{
// clear the canvas
	whiteCanvas();

// smoke check
	if(keys[32])
		smoke.push(new SmokePuff(direction ? leftPX-11 : leftPX+11, topPX-57));

// Jesus' States of being
	if(state == "falling")
	{
		if(topPX  <  (plat.spot.next.y-plat.spot.y)/(plat.spot.next.x-plat.spot.x)*(leftPX - plat.spot.x)+plat.spot.y)
		{
			if(keys[65] || keys[68])
			{
				leftPX += keys[65] ? -1*speed : speed;
			}
			tallest = document.body.clientHeight*3;
			for(jay in plats)
			{
				if(plats[jay].isOn(leftPX,topPX) && plats[jay].getY(leftPX) < tallest)
				{
					tallest = plats[jay].getY(leftPX);
					plat = plats[jay];
				}
			}
			topPX += (fallingFrame++);
		}
		else
		{
			fallingFrame = 0;
			topPX = (plat.spot.next.y-plat.spot.y)/(plat.spot.next.x-plat.spot.x)*(leftPX - plat.spot.x)+plat.spot.y;
			state = "walking";
			if(keys[65] || keys[68])
			{
				if(leftPX > plat.spot.next.x)
				{
					plat.spot = plat.spot.next;
					position++;
					if(position > plat.frontNum-2)
						plat.pushFrontRand();
				}
				else if(leftPX < plat.spot.x)
				{
					plat.spot = plat.spot.prev;
					position--;
					if(position < plat.backNum+2)
					{
						plat.pushBackRand();
					}
				}
				direction = keys[65];
			}
		}
	}
	else if (state == "walking")
	{
		if(keys[65] || keys[68] || oneLeftStep || oneRightStep)
		{
			dir = keys[65] || oneRightStep ? -1 : 1;
			leftPX += keys[65] || oneRightStep ? -1*speed : speed;
			if(leftPX > plat.spot.next.x)
			{
				if(plat.spot.next.next == undefined)
					state = "falling";
				else
				{
					plat.spot = plat.spot.next;
					position++;
					if(position > plat.frontNum-2)
						plat.pushFrontRand();
				}
			}
			else if(leftPX < plat.spot.x)
			{
				if(plat.spot.prev == undefined)
					state = "falling";
				else
				{
					plat.spot = plat.spot.prev;
					position--;
					if(position < plat.backNum+2)
					{
						plat.pushBackRand();
					}
				}
			}
			direction = keys[65];

			if(leftPX == plat.spot.x)
				topPX = plat.spot.y;
			else
				// y=mx+b
				topPX = (plat.spot.next.y-plat.spot.y)/(plat.spot.next.x-plat.spot.x)*(leftPX-plat.spot.x) + plat.spot.y;
			direction = keys[65] || oneRightStep;
			oneLeftStep = false;
			oneRightStep = false;
		}

		if(keys[87])
			state = "jumping";
	}
	else if(state == "jumping")
	{
		if(jumpFrame == 0)
		{
			jumpFrame++;
			jumpStart = topPX;
			initialVel = get("initialVel").value;
		}
		else if(jumpFrame > 0 && jumpFrame < initialVel/10)
		{
			// topPX -= (-2*jumpFrame + 250)/50;
			topPX = jumpStart - initialVel*jumpFrame + 5*jumpFrame;
			jumpFrame+=0.2;
		}
		else
		{
			jumpFrame = 0;
			state = "falling";
		}

		if(keys[65] || keys[68])
		{
			leftPX += keys[65] ? -1*speed : speed;
			// if(leftPX > plat.spot.next.x)
			// {
			// 	if(plat.spot.next.next == undefined)
			// 		state = "falling";
			// 	else
			// 	{
			// 		plat.spot = plat.spot.next;
			// 		position++;
			// 		if(position > plat.frontNum-2)
			// 			plat.pushFrontRand();
			// 	}
			// }
			// else if(leftPX < plat.spot.x)
			// {
			// 	if(plat.spot.prev == undefined)
			// 		state = "falling";
			// 	else
			// 	{
			// 		plat.spot = plat.spot.prev;
			// 		position--;
			// 		if(position < plat.backNum+2)
			// 		{
			// 			plat.pushBackRand();
			// 		}
			// 	}
			// }
			direction = keys[65];
		}
	}


// DRAW THE REALITY

	// ctx.translate(-1*leftPX+document.body.clientWidth/2,-1*topPX+document.body.clientHeight/2);
	ctx.translate(-1*leftPX+document.body.clientWidth/2,0);
	// desertBackground(0,0,document.body.clientWidth-30);
	if(leftPX > 0)
	{
		ctx.drawImage(spaceBG, leftPX-(leftPX)%spaceBG.width,0);
		if((leftPX)%spaceBG.width > spaceBG.width/2)
			ctx.drawImage(spaceBG, leftPX-(leftPX)%spaceBG.width+spaceBG.width, 0);
		else if((leftPX)%spaceBG.width < spaceBG.width/2)
			ctx.drawImage(spaceBG, leftPX-(leftPX)%spaceBG.width-spaceBG.width, 0);
	}
	else if(leftPX < 0)
	{
		thing = -1*(leftPX)%spaceBG.width;
		ctx.drawImage(spaceBG,  leftPX-(leftPX)%spaceBG.width-spaceBG.width,0);
		if(-1*(leftPX)%spaceBG.width > spaceBG.width/2)
			ctx.drawImage(spaceBG, leftPX-(leftPX)%spaceBG.width-2*spaceBG.width, 0);
		else if(-1*(leftPX)%spaceBG.width < spaceBG.width/2)
			ctx.drawImage(spaceBG, leftPX-(leftPX)%spaceBG.width, 0);
	}
	else if(leftPX == 0)
	{
		ctx.drawImage(spaceBG,leftPX-leftPX%spaceBG.width-spaceBG.width,0);
		ctx.drawImage(spaceBG,leftPX-leftPX%spaceBG.width,0);
	}

	get("keyCodes").innerHTML = "<h1 style='color:blue;'>Left: "+leftPX+', Position: '+position+', TopPX: '+topPX+'</h1>';

	
	ctx.fillStyle = "#384ea0";
	ctx.beginPath();
	ctx.moveTo(plats[1].back.x,plats[1].back.y);
	plats[1].loopFromBack(lineTo);
	ctx.lineTo(plats[1].front.x, document.body.clientHeight);
	ctx.lineTo(plats[1].back.x, document.body.clientHeight);
	ctx.closePath();
	ctx.fill();

	if(keys[32])
		if(direction)
			ctx.drawImage(jesusRS, leftPX-11, topPX-57);
		else
			ctx.drawImage(jesusLS, leftPX-6, topPX-57);
	else
		if(direction)
			ctx.drawImage(jesusR, leftPX-6, topPX-57);
		else
			ctx.drawImage(jesusL, leftPX-6, topPX-57);
	for(i in smoke)
	{
		if(smoke[i] != undefined)
		{
			smoke[i].moveNext();
			if(!smoke[i].visible)
				smoke[i] = undefined;
		}
	}	

	ctx.fillStyle = rgb(250,150,100);
	ctx.beginPath();
	ctx.moveTo(plat.back.x,plat.back.y);
	plat.loopFromBack(lineTo);
	ctx.lineTo(plat.front.x, document.body.clientHeight);
	ctx.lineTo(plat.back.x, document.body.clientHeight);
	ctx.closePath();
	ctx.fill();



	ctx.fillStyle = "white";
	for(jay in plats)
		plats[jay].loopFromFront(writeAt);
	function writeAt(x,y)
	{
		ctx.fillText(y,x,y);
	}

	function lineTo(x,y)
	{
		ctx.lineTo(x,y);
	}

	// ctx.translate(leftPX-document.body.clientWidth/2,topPX-document.body.clientHeight/2);
	ctx.translate(leftPX-document.body.clientWidth/2,0);
	setTimeout(render,10);
}
render();

function keyBooleans()
{
	// speed++;
	if(event.type=="keydown")
	{
		keys[event.which] = true;
	}

	else if(event.type == "keyup")
	{
		keys[event.which] = false;		
	}
	// if(!(keyA || keyD || keyW || keyS))
	// 	speed = 0;	
}

function SmokePuff(initialPosX, initialPosY)
{
	this.x = initialPosX;
	this.y = initialPosY;
	this.lifetime = 0;
	this.visible = true;
	this.transparency = 1;
	this.draw = function()
	{
		// ctx.strokeStyle = rgba(127,127,127,transparency);
		ctx.globalAlphaProperty = this.transparency;
		ctx.fillStyle = rgb(127,127,127);
		// ctx.moveTo(this.x,this.y);
		// ctx.lineTo(this.x+1,this.y+1);
		ctx.fillRect(this.x,this.y,2,2);
		ctx.globalAlphaProperty = 1;
	}

	this.moveNext = function()
	{
		this.y -= 0.5;
		this.lifetime++;
		this.transparency -= 1/100;
		this.draw();
		if(this.lifetime > 200)
			this.visible = false;
	}
}

function Platform(x,y,name)
{
	x = x == undefined ? 0 : x;
	y = y == undefined ? document.body.clientHeight - Math.round(Math.random()*300)-100 : y;
	this.middle = new Node(x,y);
	this.name = name;
	this.front = this.middle;
	this.back = this.middle;
	this.frontNum = 0;
	this.backNum = 0;
	this.spot = this.middle;

	this.get = function(num)
	{
		// check edges
		if(num < this.backNum)
			return false;
		else if(num > this.frontNum)
			return false;
		if(num == this.backNum)
			return this.back;
		if(num == this.frontNum)
			return this.front;

		// check elsewhere
		temp = this.middle;
		if(num == 0)
			return temp;
		else if(num < 0)
			for(i=0; i < -1*(num); i++)
				temp = temp.prev;
		else if(num > 0)
			for(i=0; i < num; i++)
				temp = temp.next;
		return temp;
	}

	this.pushFront = function(x,y)
	{
		if(x == undefined || y == undefined)
			this.pushFrontRand();
		else
		{
			this.front.next = new Node(x,y);
			this.front.next.prev = this.front;
			this.front = this.front.next;
			this.frontNum++;
		}
	}

	this.pushFrontRand = function()
	{
		this.front.next = new Node(this.front.x+Math.round(Math.random()*200)+100,document.body.clientHeight - Math.round(Math.random()*300)-100);
		this.front.next.prev = this.front;
		this.front = this.front.next;
		this.frontNum++;
	}

	this.pushBack = function(x,y)
	{
		if(x == undefined || y == undefined)
			this.pushBackRand();
		else
		{
			this.back.prev = new Node(x,y);
			this.back.prev.next = this.back;
			this.back = this.back.prev;
			this.backNum--;	
		}	
	}

	this.pushBackRand = function()
	{
		this.back.prev = new Node(this.back.x-Math.round(Math.random()*200)-100, document.body.clientHeight - Math.round(Math.random()*300)-100);
		this.back.prev.next = this.back;
		this.back = this.back.prev;
		this.backNum--;		
	}

	this.loopFromFront = function(func)
	{
		temp = this.front;
		while(temp.prev != undefined)
		{
			func(temp.x, temp.y);
			temp = temp.prev;
		}
		func(temp.x, temp.y);
	}

	this.loopFromBack = function(func)
	{
		temp = this.back;
		while(temp.next != undefined)
		{
			func(temp.x, temp.y);
			temp = temp.next;
		}
		func(temp.x, temp.y);
	}

	this.getY = function(x)
	{
		if(this.spot == undefined)
			return false;
		return (this.spot.next.y-this.spot.y)/(this.spot.next.x-this.spot.x)*(leftPX-this.spot.x) + this.spot.y;
	}

	this.isOn = function(x,y)
	{		
		temp = this.back;
		if(x < temp.x)
			return false;
		if(this.front.x < x)
			return false;
		while(temp.next != undefined)
		{
			if(temp.x <= x && x <= temp.next.x)
			{
				this.spot = temp;
				if(y <= this.getY(x))
					return temp;
				else
					return false;
			}
			temp = temp.next;
		}
		return false;
	}

	function Node(x,y)
	{
		this.name = "Node";
		this.next = null;
		this.prev = null;
		this.x = x;
		this.y = y;
	}
}

// Person: Jesus, stop being a son of a bitch.
// Jesus: I'm not; I'm the son of God, man.

// IDEA:
// 	Jesus needs to moonwalk on water
</script>
</body>
</html>
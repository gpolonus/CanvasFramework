<html>
<head>
	<style>
	canvas
	{
		position: absolute;
		top: 0px;
		left: 0px;
		z-index: -3;
	}
	</style>
</head>
<body onkeydown="keyBooleans()" onkeyup="keyBooleans()">
<div id="keyCodes"></div>
<button onclick="oneRightStep=true">One Right Step</button><button onclick="oneLeftStep=true">One Left Step</button><br>
<input type="number" id="initialVel" value="30">
<image src="Art/Jesusv2L.png" style="display:none" id="JesusImgL">
<image src="Art/Jesusv2LS.png" style="display:none" id="JesusImgLS">
<image src="Art/Jesusv2R.png" style="display:none" id="JesusImgR">
<image src="Art/Jesusv2RS.png" style="display:none" id="JesusImgRS">
<canvas id="canvas"></canvas>
<script src="js/colorFuns.js"></script>
<script src="js/drawnFunctions.js"></script>
<script src="js/canvasLibrary.js"></script>
<script>

var keys = new Array();
for(i=1;i<150;i++)
	keys[i] = false;
var leftPX = 0;
var topPX = 0;
var speed = 2;
var dogHeight = 63;
var dogLength = 100;
var canvas = get("canvas");
var ctx = canvas.getContext("2d");
var jesusL = get("JesusImgL");
var jesusR = get("JesusImgR");
var jesusLS = get("JesusImgLS");
var jesusRS = get("JesusImgRS");
ctx.canvas.height = document.body.clientHeight-30;
ctx.canvas.width = document.body.clientWidth-30;
ctx.font = "14px Arial";

function get(id)
{
	return document.getElementById(id);
}

function nothing(){}

function showKeyCode()
{
	// get("keyCodes").innerHTML = "<h1 style='color:blue;'>"+topPX+'</h1>';
}

var direction = false;
// var dogLength = 200;
// var dogHeight = 126;
var state = "falling";
var level = new Array();
var jumpFrame = 0;
var gaps = 300;
var realityPos = 0;
var oneRightStep = false;
var oneLeftStep = false;
var jumpStart = 0;
var initialVel = 30;
var fallingFrame = 0;
var smoke = new Array();
var position = 0;
i = 0;
length = 0;
while(length < document.body.clientWidth-30)
{
	level[i] = [];
	if(i==0)
		level[i].x = 0;
	else
		level[i].x = length;
	length += Math.round(Math.random()*200)+100;
	level[i].plane = 0;
	level[i++].y = document.body.clientHeight - Math.round(Math.random()*300)-100;
}

function render()
{
	whiteCanvas();

	if(keys[32])
	{
		smoke.push(new SmokePuff(direction ? leftPX-11 : leftPX+11, topPX-57));
	}

	if(state == "falling")
	{
		if(topPX  <  (level[position+1].y-level[position].y)/(level[position+1].x-level[position].x)*(leftPX - level[position].x)+level[position].y)
		{
			topPX += (fallingFrame++);
		}
		else
		{ 
			fallingFrame = 0;
			topPX = (level[position+1].y-level[position].y)/(level[position+1].x-level[position].x)*(leftPX - level[position].x)+level[position].y;
			state = "walking";
		}

		if(keys[65] || keys[68])
		{
			leftPX += keys[65] ? -1*speed : speed;
			if(leftPX > level[position+1].x)
				position++;
			else if(leftPX < level[position].x)
				position--;
			direction = keys[65];
		}
	}
	else if (state == "walking")
	{
		if(keys[65] || keys[68] || oneLeftStep || oneRightStep)
		{
			dir = keys[65] || oneRightStep ? -1 : 1;
			leftPX += keys[65] || oneRightStep ? -1*speed : speed;
			if(leftPX > level[position+1].x)
				position++;
			else if(leftPX < level[position].x)
				position--;

			if(leftPX ==  level[position].x)
				topPX = level[position].y;
			else
				// y=mx+b
				topPX = (level[position+1].y-level[position].y)/(level[position+1].x-level[position].x)*(leftPX-level[position].x) + level[position].y;
			realityPos += keys[65] || oneRightStep ? -1*speed : speed;
			direction = keys[65] || oneRightStep;
			oneLeftStep = false;
			oneRightStep = false;
		}

		if(keys[87])
			state = "jumping";
	}
	else if(state == "jumping")
	{
		if(jumpFrame == 0)
		{
			jumpFrame++;
			jumpStart = topPX;
			initialVel = get("initialVel").value;
		}
		else if(jumpFrame > 0 && jumpFrame < initialVel/10)
		{
			// topPX -= (-2*jumpFrame + 250)/50;
			topPX = jumpStart - initialVel*jumpFrame + 5*jumpFrame;
			jumpFrame+=0.2;
		}
		else
		{
			jumpFrame = 0;
			state = "falling";
		}

		if(keys[65] || keys[68])
		{
			leftPX += keys[65] ? -1*speed : speed;
			if(leftPX > level[position+1].x)
				position++;
			else if(leftPX < level[position].x)
				position--;
			direction = keys[65];
		}
	}

	// make the dogThing walk
	// dirColor = direction ? "blue" : "red";
	// drawFillSquare(leftPX-10,topPX-10,20,dirColor);
	showKeyCode();
	// drawFillSquare(leftPX+dogLength/2,topPX+130,-1*gaps,"#0ff");

	// draw the level
	// drawFillSquare(100,500,1000,"blue");
	desertBackground(0,0,document.body.clientWidth-30);
	// dogThing(leftPX-dogLength/2,topPX-dogHeight,dogLength,direction,ctx);


	get("keyCodes").innerHTML = "<h1 style='color:blue;'>Left: "+leftPX+', Position: '+position+', TopPX: '+topPX+'</h1>';

	if(keys[32])
		if(direction)
			ctx.drawImage(jesusRS, leftPX-11, topPX-57);
		else
			ctx.drawImage(jesusLS, leftPX-6, topPX-57);
	else
		if(direction)
			ctx.drawImage(jesusR, leftPX-6, topPX-57);
		else
			ctx.drawImage(jesusL, leftPX-6, topPX-57);
	for(i in smoke)
	{
		if(smoke[i] != undefined)
		{
			smoke[i].moveNext();
			if(!smoke[i].visible)
				smoke[i] = undefined;
		}
	}
	ctx.fillStyle = rgb(250,150,100);
	ctx.beginPath();
	ctx.moveTo(level[0].x,level[0].y);
	for(i=1;i < level.length;i++)
	{
		ctx.lineTo(level[i].x,level[i].y);
		// ctx.fillText(level[i],i,level[i]);
	}
	ctx.lineTo(document.body.clientWidth,document.body.clientHeight);
	ctx.lineTo(0,document.body.clientHeight);
	ctx.closePath();
	ctx.fill();
	ctx.fillStyle = "black";
	for(i=0;i<level.length;i++)
	{
		ctx.fillText(level[i].y,level[i].x,level[i].y);
	}

	setTimeout(render,10);
}
render();

function keyBooleans()
{
	// speed++;
	if(event.type=="keydown")
	{
		keys[event.which] = true;
	}

	else if(event.type == "keyup")
	{
		keys[event.which] = false;		
	}
	// if(!(keyA || keyD || keyW || keyS))
	// 	speed = 0;	
}

function SmokePuff(initialPosX, initialPosY)
{
	this.x = initialPosX;
	this.y = initialPosY;
	this.lifetime = 0;
	this.visible = true;
	this.transparency = 1;
	this.draw = function()
	{
		ctx.lineWidth = 1;
		// ctx.strokeStyle = rgba(127,127,127,transparency);
		ctx.strokeStyle = rgb(127,127,127);
		ctx.beginPath();
		ctx.moveTo(this.x,this.y);
		ctx.lineTo(this.x+1,this.y+1);
		ctx.closePath();
		ctx.stroke();
	}

	this.moveNext = function()
	{
		this.y -= 0.5;
		this.lifetime++;
		this.transparency -= 1/200;
		this.draw();
		if(this.lifetime > 200)
			this.visible = false;
	}
}

// Person: Jesus, stop being a son of a bitch.
// Jesus: I'm not; I'm the son of God, man.

// IDEA:
// 	Jesus needs to moonwalk on water
</script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
<title>Test</title>
</head>

<script src="draw.js"></script>
<script type="text/javascript">


function init() {

	//Initialize Images
	imageObj = new Image();
	imageObj.src = 'ab.png';
	
	imageObj2 = new Image();
	imageObj2.src = 'abL.png';

	imageObj3 = new Image();
	imageObj3.src = 'ab2.png';
	
	imageObj4 = new Image();
	imageObj4.src = 'abL2.png';
	
	imageObj5 = new Image();
	imageObj5.src = 'city.png';
	
	imageObj6 = new Image();
	imageObj6.src = 'backmid.png';
	
	imageObj7 = new Image();
	imageObj7.src = 'box.png';

	jesusL = new Image();
	jesusL.src = "../Art/JesusL.png";

	jesusR = new Image();
	jesusR.src = "../Art/JesusR.png";

	jesusLS = new Image();
	jesusLS.src = "../Art/JesusLS.png";

	jesusRS = new Image();
	jesusRS.src = "../Art/JesusRS.png";
	
	
	
	
	unicode = 0;
	
	//Initialize Game vars
	game = new Object();
	game.tileSize = 10; //tile width and height in pixels; MAKE IT 100!
	game.height = 60; //game height in tiles
	game.width = 80; // game width in tiles
	game.frameHeight = game.tileSize*game.height; //game container height in pixels
	game.frameWidth = game.tileSize*game.width; //game container width in pixels
	
		//Initialize ground
		game.ground = new Array();
		game.groundIndex = 0;
		game.levelIndex = 0;
		
		game.ground[0] = [];
		game.ground[1] = [];
		game.ground[2] = [];
		game.ground[3] = [];
		game.ground[0][-1] = new Array(16,16,15,15,14,13,13,13,13,13,13,12,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,13,13,13,13,13,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,14,14,14,14,14);
		game.ground[1][-1] = new Array(undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,58,51,44,38,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,19,19,19,19,19,19,19,19,19,19,19,19,19,19,18,18,18,18,18,18,18,18,18,18,18,17,17,17,17,17,18,18,18,18,18,18,18,18,18,18,18,18,18,19,19,19,19);
		game.ground[2][-1] = new Array();
		game.ground[3][-1] = new Array();

		game.ground[0][0] = new Array(7,7,7,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,10,10,10,9,8,7,6,6,5,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,6,6,6,6,6,6,7,7,7,7,7,7,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9);
		game.ground[1][0] = new Array(undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,15,15,15,15,15,15,15,14,14,14,14,14,14,13,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12);
		game.ground[2][0] = new Array(undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,13,13,14,15,16,16,17,17,17,17,17,17,17,17,undefined,18,18,18,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,19,18,17,16,16,16,16,16,16,16);
		game.ground[3][0] = new Array(25,25);

		game.ground[0][1] = new Array(14,15,15,16,17,17,17,17,17,17,17,17,17,16,16,16,16,16,15,15,14,14,14,13,13,13,12,12,12,12,11,11,11,10,10,10,10,10,10,10,9,9,9,9,8,8,8,8,7,7,7,7,7,7,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11);
		game.ground[1][1] = new Array(undefined,undefined,undefined,undefined,19,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,20,20,20,20,20,20,20,20,20,19,19,19,19,19,18,18,18,17,17,17,17,16,16,16,15,15,15,15,14,14,14,14,14,14,14,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,15,15,15,15,15,15,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,18,18);
		game.ground[2][1] = new Array(undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,26,26,27,27,27,28,28,28,28,28,29,29,29,29,29,29,29,29,29,29,29,28,28,28,28,28,28,28,28,28,27,27,27,27,26,26,26,26,26,26,26,25,25,25,24,24,23,23,23,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23);
		game.ground[3][1] = new Array(undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,35,35,35,36,36,36,36,37,37,37,36,36,36,36,36,36,36,36,36,36,35,35,35,35,35,34,34,34,34,34,34,33,33,33,32,32,32,32,31,31,31,31,30,30,30,30,29,29,29,29,29,undefined,29,29,29,29,29,29,29);


		game.groundIndex = 0;

	
	
	//Initialize Player
	player = new Object();
	player.speed = 1;
	
	//true = right, false = left
	player.direction = true;
	player.walkPattern = true;
	
	
	player.vVel = 0;
	player.x = 0;
	player.y = game.ground[game.levelIndex][0][0]+1;
	player.width = 12/game.tileSize;
	player.height = 57/game.tileSize;

	player.fireX = 0;
	player.fireY = 0;
	player.fireToggle = 0;
	
	player.fuel = 1000;
	player.weapon = 1;
	
	//Initialize bullets
	bullets = new Object();
	bullets.index = 0;
	bullets.array = new Array();
	
	//Initialize placed building materials
	placed = new Object();
	placed.index = 0;
	placed.array = new Array();
	
	//Initialze Trigger Object
	trigger = new Object();
	trigger.response = false;
	trigger.type = 0;
	
	//Initialize Keys
	keys = new Object();
	
	//initialize mouse
	mouse = new Object();
	
	
	//Initialize Canvas
	c = document.getElementById("blah");
	c.width = game.frameWidth;
	c.height = game.frameHeight;
	ctx = c.getContext("2d");
	
	
	
	
	//Start main loop
	mainLoop();
}

function keyDown(e) {

			//var unicode=e.keyCode? e.keyCode : e.charCode
			if (e.keyCode) {var unicode = e.keyCode}
			//if (e.charCode) {var unicode = e.charCode}

			if (unicode == 87) {keys.up = 1;}
			if (unicode == 65) {keys.left = 1;}
			if (unicode == 83) {keys.down = 1;}
			if (unicode == 68) {keys.right = 1;}
			if (unicode == 32) {keys.space = 1;}
			if (unicode == 16) {keys.shift = 1;}

}

function keyUp(e) {

			//var unicode=e.keyCode? e.keyCode : e.charCode
			if (e.keyCode) {var unicode = e.keyCode}
			//if (e.charCode) {var unicode = e.charCode}

			if (unicode == 87) {keys.up = 0;}
			if (unicode == 65) {keys.left = 0;}
			if (unicode == 83) {keys.down = 0;}
			if (unicode == 68) {keys.right = 0;}
			if (unicode == 32) {keys.space = 0;}
			if (unicode == 16) {keys.shift = 0;}

}

		//		    87 W
		//	65 A	83 S	68 D

		
function mouseDown(e) {

			player.fireToggle = 1;
		
			var xOffset=Math.max(document.documentElement.scrollLeft,document.body.scrollLeft);
			var yOffset=Math.max(document.documentElement.scrollTop,document.body.scrollTop);

			mouse.x = e.clientX + xOffset - c.offsetLeft;
			mouse.y = e.clientY + yOffset - c.offsetTop;
			
			player.fireX = Math.floor(mouse.x/game.tileSize);
			player.fireY = game.frameHeight/game.tileSize - Math.floor(mouse.y/game.tileSize);

}

function mouseUp(e) {

			player.fireToggle = 0;

			mouse.x = 0;
			mouse.y = 0;
			
			player.fireX = 0;
			player.fireY = 0;
			

}		

function mouseMove(e) {
	if (player.fireToggle == 1) {
		mouseDown(e);
	}
}

function updateHorizPos() {

	
	
	if (keys.left == 1) {
		if (player.walkPattern == 4) {
			player.walkPattern = 0;
		} else {
			player.walkPattern++;
		}
		collisionDetectLeft();
	}
	if (keys.right == 1) {
		if (player.walkPattern == 4) {
			player.walkPattern = 0;
		} else {
			player.walkPattern++;
		}
		collisionDetectRight();
	}
}
	
function updateVertVel() {
	if (keys.up == 1) {
	
		if (placed.array[player.x]) {
			var max = placed.array[player.x].length-1;
			var diff = player.y - placed.array[player.x][max].y
		}
		else {
			var diff = player.y - game.ground[game.levelIndex][game.groundIndex][(player.x%80)];

		}
	
		if (diff <= 1.1) {
		
			player.vVel = 3;
		}
	}
	if (keys.down == 1) {
		// player.height = 3;
		game.ground[game.levelIndex][game.groundIndex][(player.x%80)] -= 1;
	}
	// else {
	// 	player.height = 3;

	// }
	
	if (keys.shift == 1) {
		
		game.ground[game.levelIndex][game.groundIndex][(player.x%80)] += 1;
	}
	
	if (keys.space == 1 && player.fuel > 0) {
		if (player.vVel < 3) {
			player.vVel=player.vVel+1;
		}
		player.fuel -= 1;
	}
	
}
		

function collisionDetectRight() {

	player.direction = true;

	
	for (i=(player.x%game.width); i < (player.x%game.width)+game.width/2; i++) { //do we really need to scan so far?
		if (player.y < game.ground[game.levelIndex][game.groundIndex][i]) {
			break;
		}
		
		if (((player.x%game.width)) == game.width-1 && player.y < game.ground[game.levelIndex][game.groundIndex+1][0]) {
			break;
		}
	}
	
	if (i-(player.x%game.width) > 1) {
		player.x = player.x + 1;
		if (((player.x%game.width)) == 0) {
			//player.x = 0;
			game.groundIndex++;
		}
	}
}

function collisionDetectLeft() {

	player.direction = false;

	
	for (i=(player.x%game.width); i > (player.x%game.width)-game.width/2; i--) { //must we scan so far??
		if (player.y < game.ground[game.levelIndex][game.groundIndex][i]) {
			break;
		}
		
		if (((player.x%game.width)) == 0 && player.y < game.ground[game.levelIndex][game.groundIndex-1][game.width-1]) {
			break;
		}
	}
	
	//This part is weird since after player.x -= 1, player.x%80 can be -1 or 79 I think
	if ((player.x%game.width)-i > 1) {
		player.x = player.x - 1;
		if (((player.x%game.width)) == game.width-1 || ((player.x%game.width)) == -1) {
			
			//In case player goes backward from 1st frame
			//if(((player.x%80)) == -1) {
			//	break;
			//}
			//player.x = 79;
			game.groundIndex--;
		}
	}
}
		
function playerGravity() {
	
	
	
	//first check for boxes under player
	if (placed.array[player.x]) {
	
	
		var max = placed.array[player.x].length-1;
		if (player.vVel >0) {
	
			//if (player.vVel == 0 && (player.y <= placed.array[player.x].y+1) ) {
			//	player.y = player.y - 1.1;
			//	
			//}
			 
			
			
			player.y = player.y + Math.round(player.vVel);			
			player.vVel = player.vVel - 0.5;
		}
			
		else if ((player.y - placed.array[player.x][max].y) > 1) {
				player.y = player.y + Math.round(player.vVel);			
				player.vVel = player.vVel - 0.5;
		}	
			
		else {
		
			if (player.y > game.ground[game.levelIndex][game.groundIndex][player.x]+1) {
				var i = 0;
				
				//currently designed so player can walk up steps with boxes on them
				while (player.y > (placed.array[player.x][i].y) && i<max) {  //this needs modification. 
					alert(placed.array[player.x][i].y + ' ' + player.y);
					i++;
				}
				
				player.vVel = 0;
				player.y = placed.array[player.x][i].y;
				
			}
			else {
				player.y = game.ground[game.levelIndex][game.groundIndex][(player.x%game.width)] + 1;
			}
			
		}
			
	}
	


	else if (player.vVel != 0 || ( (player.y - game.ground[game.levelIndex][game.groundIndex][(player.x%game.width)]) > 1) ) {
	
		if (player.vVel == 0 && (player.y <= game.ground[game.levelIndex][game.groundIndex][(player.x%game.width)-1]+1) ) {
			player.y = player.y - 1.1;
			
		} else {
		
			player.y = player.y + Math.round(player.vVel);	
		}
		player.vVel = player.vVel - 0.5;
		
		
		
		if ((player.y - game.ground[game.levelIndex][game.groundIndex][(player.x%game.width)]) <= 1) {
			player.vVel = 0;
			player.y = game.ground[game.levelIndex][game.groundIndex][(player.x%game.width)] + 1;
		}
	

	}
	else if (Math.floor(player.y) <= game.ground[game.levelIndex][game.groundIndex][(player.x%game.width)]) {
			player.y = game.ground[game.levelIndex][game.groundIndex][(player.x%game.width)] + 1;
		
	}
	
	
	// check to change levelIndex
	var maxHeightJ = 0;
	for(var j = 0; j < game.ground.length; j++) {
		// check for upper platforms that are actually lower than underneath platforms
		if (j > 0) {
			if (game.ground[j][game.groundIndex][player.x] > game.ground[maxHeightJ][game.groundIndex][player.x]) {
				maxHeightJ = j;
			}
		}
		
		// set levelIndex to platform the player is above
		if (player.y > game.ground[j][game.groundIndex][player.x] && j == maxHeightJ) {
			game.levelIndex = j;
			
			
		}
	}
	
	
	
}


function playerShoot() {
	
	if (player.fireX != 0) {
		
		var dirX = player.fireX - game.width/2;
		var dirY = player.fireY - game.height/2 - player.height;
		var dirT = Math.sqrt(dirX*dirX + dirY*dirY);
		
		switch(player.weapon) {
		
			case 1: //Default gun (for now)
				//THIS IS THE LAKE
				bullets.array[bullets.index] = new Object();
				bullets.array[bullets.index].x = player.x;
				bullets.array[bullets.index].y = player.y + player.height - 2;
				
				bullets.array[bullets.index].dirX = dirX/dirT;
				bullets.array[bullets.index].dirY = dirY/dirT;
				
				bullets.index++;
				break;
			
			case 2: // box placer
				if (!placed.array[player.x]) { //Only place if object does not already exist
					placed.array[player.x] = new Array();
					placed.array[player.x][0] = new Object();
					placed.array[player.x][0].x = player.x;
					placed.array[player.x][0].y = game.ground[game.levelIndex][game.groundIndex][player.x%game.width]+1;
					placed.array[player.x][0].boxType = 1;
				}
				else if (placed.array[player.x][placed.array[player.x].length - 1].y < player.y) {//put another on top if top is lower than player
					
					var newIndex = placed.array[player.x].length
					if (player.y != placed.array[player.x][newIndex - 1].y) {
						placed.array[player.x][newIndex] = new Object();
						placed.array[player.x][newIndex].x = player.x;
						placed.array[player.x][newIndex].y = placed.array[player.x][newIndex - 1].y+1;
						placed.array[player.x][newIndex].boxType = 1;
					}
				}
				
				break;
			
			default:
				break;
		}
	}
}	

	


function updateBullets() {

	for(i=0; i<bullets.index; i++) {
		bullets.array[i].x += bullets.array[i].dirX*4 + Math.random()/5;
		bullets.array[i].y += bullets.array[i].dirY*4 + Math.random()/10;
		
	}
}

function triggerResponseDraw() {
	if (trigger.response) {
		switch(trigger.type) {
		
			case 1: //cutscene character communication
				drawAlertMessage(ctx);
				break;
			
			default:
				break;
		}
	
	}

}


function mainLoop() {

	updateVertVel();
	updateHorizPos();
	playerGravity();
	
	playerShoot();
	

	ctx.clearRect(0,0,game.frameWidth,game.frameHeight);
	drawBackground(ctx);
	drawGround(ctx);
	drawPlaced(ctx);
	drawPlayer(ctx);
	
	
	if (bullets.index) {
		updateBullets();
		drawBullets(ctx);
	}
	
	
	//Debug output 
	document.getElementById('status').innerHTML = game.ground[0][game.groundIndex][player.x] + " " + game.ground[1][game.groundIndex][player.x] + " " + game.ground[2][game.groundIndex][player.x] + " " + game.ground[3][game.groundIndex][player.x] + "<br />" + game.levelIndex + " " + player.y;

	if (player.x == 10) {
		trigger.response = true;
		trigger.type = 1;
	}
	else {
		trigger.response = false;
	}
	triggerResponseDraw();
		
		
	setTimeout(mainLoop,50);
}



//Start initialization when the page loads
window.onload = init;
</script>

<style type="text/css">


</style>

<body onkeydown="keyDown(event);" onkeyup="keyUp(event);" onmousedown="mouseDown(event);" onmouseup="mouseUp(event);" onmousemove="mouseMove(event);">


<canvas id="blah" width="800px" height="600px" style="border:1px solid black;"></canvas>

<div id="status">p</div>



<!--
// Person: Jesus, stop being a son of a bitch.
// Jesus: I'm not; I'm the son of God, man.

// IDEA:
// 	Jesus needs to moonwalk on water

Have Jesus jump around lava in hell after crucifiction

-->








</body>
</html>
<!DOCTYPE html>
<html>
<head>
<title>Test</title>
</head>

<script src="draw.js"></script>
<script type="text/javascript">


function init() {

	//Initialize Images
	imageObj = new Image();
	imageObj.src = 'ab.png';
	
	imageObj2 = new Image();
	imageObj2.src = 'abL.png';

	imageObj3 = new Image();
	imageObj3.src = 'ab2.png';
	
	imageObj4 = new Image();
	imageObj4.src = 'abL2.png';
	
	imageObj5 = new Image();
	imageObj5.src = 'city.png';
	
	imageObj6 = new Image();
	imageObj6.src = 'backmid.png';
	
	imageObj7 = new Image();
	imageObj7.src = 'box.png';
	
	
	
	
	unicode = 0;
	
	//Initialize Game vars
	game = new Object();
	game.tileSize = 10; //tile width and height in pixels; MAKE IT 100!
	game.height = 60; //game height in tiles
	game.width = 80; // game width in tiles
	game.frameHeight = game.tileSize*game.height; //game container height in pixels
	game.frameWidth = game.tileSize*game.width; //game container width in pixels
	
		//Initialize ground
		game.ground = new Array();
		game.groundIndex = 0;
		
		game.ground[-1] = new Array(50, 50, 50, 49, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 47, 46, 45, 45, 47, 47, 47, 47, 47, 48, 47, 47, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 49, 48, 48, 48, 48, 48, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 46, 45, 45, 48, 44, 43, 42, 41, 40, 38, 37, 36, 35, 35, 32, 31, 29, 27, 26, 30, 34, 35);
		game.ground[0] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[1] = new Array(20, 21, 22, 22, 23, 24, 24, 25, 26, 28, 29, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 41, 42, 42, 43, 44, 44, 45, 45, 45, 46, 47, 47, 47, 47, 47, 47, 47, 46, 46, 46, 46, 46, 46, 46, 46, 46, 46, 46, 47, 47, 48, 48, 49, 50, 50, 50, 50, 51, 51, 51, 52, 53, 53, 54, 57, 59, 62, 64, 66, 68, 70, 70, 71, 72, 72, 73, 73, 73);
		game.ground[2] = new Array(72, 72, 72, 72, 72, 72, 73, 73, 73, 73, 72, 72, 72, 73, 73, 74, 75, 76, 76, 77, 78, 79, 79, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 81, 81, 81, 82, 82, 84, 85, 86, 87, 88, 89, 90, 91, 92, 92, 92, 92, 92, 92, 91, 91, 91, 91, 90, 90, 90, 95, 97, 97, 98, 99, 99, 100, 100, 101, 102, 102, 103, 103, 104, 105, 105, 106, 107, 108);
		game.ground[3] = new Array(108, 109, 110, 111, 112, 112, 114, 115, 116, 118, 127, 125, 122, 123, 125, 126, 129, 131, 133, 134, 136, 137, 137, 137, 137, 137, 137, 137, 137, 139, 143, 144, 148, 148, 143, 141, 134, 134, 133, 133, 133, 133, 133, 134, 134, 134, 136, 136, 138, 139, 140, 141, 142, 143, 144, 144, 145, 148, 146, 151, 148, 150, 155, 162, 162, 162, 162, 163, 163, 163, 164, 165, 211, 165, 166, 167, 167, 167, 167, 167);
		game.ground[4] = new Array(167, 167, 167, 167, 167, 167, 167, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 168, 170, 171, 171, 172, 172, 171, 171, 169, 169, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 167, 167, 167, 167, 167, 167, 167, 167);
		game.ground[5] = new Array(167, 167, 167, 167, 167, 167, 166, 163, 159, 158, 157, 156, 154, 120, 119, 122, 120, 119, 118, 117, 116, 114, 113, 112, 110, 109, 109, 108, 108, 108, 108, 108, 107, 107, 107, 107, 107, 108, 107, 107, 107, 106, 107, 107, 107, 107, 107, 107, 107, 106, 106, 106, 106, 106, 113, 113, 113, 112, 110, 109, 109, 108, 108, 108, 108, 108, 108, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 106);
		game.ground[6] = new Array(106, 105, 101, 100, 98, 96, 94, 92, 66, 62, 49, 44, 31, 29, 13, 11, 5, 2, -2, -4, -7, -8, -9, -10, -10, -10, -11, -11, -11, -11, -11, -11, -11, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -11, -11, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -12, -11, -12, -12, -12, -12, -13, -13, -12, -12, -12, -12, -13);
		game.ground[7] = new Array(-9, -9, -9, -8, -7, -6, -6, -5, -5, -4, -4, -4, -4, -4, -4, -4, -4, -3, -3, -3, -2, -2, -2, -1, -1, -1, -1, 1, 2, 2, 0, -2, -1, 1, 2, 2, 3, 4, 4, 4, 5, 6, 6, 6, 7, 7, 8, 8, 8, 9, 9, 9, 10, 9, 10, 10, 10, 10, 10, 11, 11, 12, 13, 13, 14, 14, 15, 15, 16, 17, 17, 18, 18, 18, 18, 19, 19, 19, 19, 19);
	
	
	//Initialize Player
	player = new Object();
	player.speed = 1;
	
	//true = right, false = left
	player.direction = true;
	player.walkPattern = true;
	
	
	player.vVel = 0;
	player.x = 0;
	player.y = game.ground[0][0]+1;
	player.width = 1;
	player.height = 3;

	player.fireX = 0;
	player.fireY = 0;
	player.fireToggle = 0;
	
	player.fuel = 1000;
	player.weapon = 1;
	
	//Initialize bullets
	bullets = new Object();
	bullets.index = 0;
	bullets.array = new Array();
	
	//Initialize placed building materials
	placed = new Object();
	placed.index = 0;
	placed.array = new Array();
	
	//Initialze Trigger Object
	trigger = new Object();
	trigger.response = false;
	trigger.type = 0;
	
	//Initialize Keys
	keys = new Object();
	
	//initialize mouse
	mouse = new Object();
	
	
	//Initialize Canvas
	c = document.getElementById("blah");
	c.width = game.frameWidth;
	c.height = game.frameHeight;
	ctx = c.getContext("2d");
	
	
	
	
	//Start main loop
	mainLoop();
}

function keyDown(e) {

			//var unicode=e.keyCode? e.keyCode : e.charCode
			if (e.keyCode) {var unicode = e.keyCode}
			//if (e.charCode) {var unicode = e.charCode}

			if (unicode == 87) {keys.up = 1;}
			if (unicode == 65) {keys.left = 1;}
			if (unicode == 83) {keys.down = 1;}
			if (unicode == 68) {keys.right = 1;}
			if (unicode == 32) {keys.space = 1;}
			if (unicode == 16) {keys.shift = 1;}

}

function keyUp(e) {

			//var unicode=e.keyCode? e.keyCode : e.charCode
			if (e.keyCode) {var unicode = e.keyCode}
			//if (e.charCode) {var unicode = e.charCode}

			if (unicode == 87) {keys.up = 0;}
			if (unicode == 65) {keys.left = 0;}
			if (unicode == 83) {keys.down = 0;}
			if (unicode == 68) {keys.right = 0;}
			if (unicode == 32) {keys.space = 0;}
			if (unicode == 16) {keys.shift = 0;}

}

		//		    87 W
		//	65 A	83 S	68 D

		
function mouseDown(e) {

			player.fireToggle = 1;
		
			var xOffset=Math.max(document.documentElement.scrollLeft,document.body.scrollLeft);
			var yOffset=Math.max(document.documentElement.scrollTop,document.body.scrollTop);

			mouse.x = e.clientX + xOffset - c.offsetLeft;
			mouse.y = e.clientY + yOffset - c.offsetTop;
			
			player.fireX = Math.floor(mouse.x/game.tileSize);
			player.fireY = game.frameHeight/game.tileSize - Math.floor(mouse.y/game.tileSize);

}

function mouseUp(e) {

			player.fireToggle = 0;

			mouse.x = 0;
			mouse.y = 0;
			
			player.fireX = 0;
			player.fireY = 0;
			

}		

function mouseMove(e) {
	if (player.fireToggle == 1) {
		mouseDown(e);
	}
}

function updateHorizPos() {

	
	
	if (keys.left == 1) {
		if (player.walkPattern == 4) {
			player.walkPattern = 0;
		} else {
			player.walkPattern++;
		}
		collisionDetectLeft();
	}
	if (keys.right == 1) {
		if (player.walkPattern == 4) {
			player.walkPattern = 0;
		} else {
			player.walkPattern++;
		}
		collisionDetectRight();
	}
}
	
function updateVertVel() {
	if (keys.up == 1) {
	
		if (placed.array[player.x]) {
			var max = placed.array[player.x].length-1;
			var diff = player.y - placed.array[player.x][max].y
		}
		else {
			var diff = player.y - game.ground[game.groundIndex][(player.x%80)];

		}
	
		if (diff <= 1.1) {
		
			player.vVel = 3;
		}
	}
	if (keys.down == 1) {
		player.height = 3;
		game.ground[game.groundIndex][(player.x%80)] -= 1;
	}
	else {
		player.height = 3;

	}
	
	if (keys.shift == 1) {
		
		game.ground[game.groundIndex][(player.x%80)] += 1;
	}
	
	if (keys.space == 1 && player.fuel > 0) {
		if (player.vVel < 3) {
			player.vVel=player.vVel+1;
		}
		player.fuel -= 1;
	}
	
}
		

function collisionDetectRight() {

	player.direction = true;

	
	for (i=(player.x%80); i < (player.x%80)+40; i++) {
		if (player.y < game.ground[game.groundIndex][i]) {
			break;
		}
		
		if (((player.x%80)) == 79 && player.y < game.ground[game.groundIndex+1][0]) {
			break;
		}
	}
	
	if (i-(player.x%80) > 1) {
		player.x = player.x + 1;
		if (((player.x%80)) == 0) {
			//player.x = 0;
			game.groundIndex++;
		}
	}
}

function collisionDetectLeft() {

	player.direction = false;

	
	for (i=(player.x%80); i > (player.x%80)-40; i--) {
		if (player.y < game.ground[game.groundIndex][i]) {
			break;
		}
		
		if (((player.x%80)) == 0 && player.y < game.ground[game.groundIndex-1][79]) {
			break;
		}
	}
	
	//This part is weird since after player.x -= 1, player.x%80 can be -1 or 79 I think
	if ((player.x%80)-i > 1) {
		player.x = player.x - 1;
		if (((player.x%80)) == 79 || ((player.x%80)) == -1) {
			
			//In case player goes backward from 1st frame
			//if(((player.x%80)) == -1) {
			//	break;
			//}
			//player.x = 79;
			game.groundIndex--;
		}
	}
}
		
function playerGravity() {
	
	//first check for boxes under player
	if (placed.array[player.x]) {
	
	
		var max = placed.array[player.x].length-1;
		if (player.vVel >0) {
	
			//if (player.vVel == 0 && (player.y <= placed.array[player.x].y+1) ) {
			//	player.y = player.y - 1.1;
			//	
			//}
			 
			
			
			player.y = player.y + Math.round(player.vVel);			
			player.vVel = player.vVel - 0.5;
		}
			
		else if ((player.y - placed.array[player.x][max].y) > 1) {
				player.y = player.y + Math.round(player.vVel);			
				player.vVel = player.vVel - 0.5;
		}	
			
		else {
		
			if (player.y > game.ground[game.groundIndex][player.x]+1) {
				var i = 0;
				
				//currently designed so player can walk up steps with boxes on them
				while (player.y > (placed.array[player.x][i].y) && i<max) {  //this needs modification. 
					alert(placed.array[player.x][i].y + ' ' + player.y);
					i++;
				}
				
				player.vVel = 0;
				player.y = placed.array[player.x][i].y;
				
			}
			else {
				player.y = game.ground[game.groundIndex][(player.x%80)] + 1;
			}
			
		}
			
	}
	


	else if (player.vVel != 0 || ( (player.y - game.ground[game.groundIndex][(player.x%80)]) > 1) ) {
	
		if (player.vVel == 0 && (player.y <= game.ground[game.groundIndex][(player.x%80)-1]+1) ) {
			player.y = player.y - 1.1;
			
		} else {
		
			player.y = player.y + Math.round(player.vVel);	
		}
		player.vVel = player.vVel - 0.5;
		
		
		
		if ((player.y - game.ground[game.groundIndex][(player.x%80)]) <= 1) {
			player.vVel = 0;
			player.y = game.ground[game.groundIndex][(player.x%80)] + 1;
		}
	

	}
	else if (Math.floor(player.y) <= game.ground[game.groundIndex][(player.x%80)]) {
			player.y = game.ground[game.groundIndex][(player.x%80)] + 1;
		
	}
}


function playerShoot() {
	
	if (player.fireX != 0) {
		
		var dirX = player.fireX - 40;
		var dirY = player.fireY - 30 - player.height;
		var dirT = Math.sqrt(dirX*dirX + dirY*dirY);
		
		switch(player.weapon) {
		
			case 1: //Default gun (for now)
				//THIS IS THE LAKE
				bullets.array[bullets.index] = new Object();
				bullets.array[bullets.index].x = player.x;
				bullets.array[bullets.index].y = player.y + player.height - 2;
				
				bullets.array[bullets.index].dirX = dirX/dirT;
				bullets.array[bullets.index].dirY = dirY/dirT;
				
				bullets.index++;
				break;
			
			case 2: // box placer
				if (!placed.array[player.x]) { //Only place if object does not already exist
					placed.array[player.x] = new Array();
					placed.array[player.x][0] = new Object();
					placed.array[player.x][0].x = player.x;
					placed.array[player.x][0].y = game.ground[game.groundIndex][player.x%80]+1;
					placed.array[player.x][0].boxType = 1;
				}
				else if (placed.array[player.x][placed.array[player.x].length - 1].y < player.y) {//put another on top if top is lower than player
					
					var newIndex = placed.array[player.x].length
					if (player.y != placed.array[player.x][newIndex - 1].y) {
						placed.array[player.x][newIndex] = new Object();
						placed.array[player.x][newIndex].x = player.x;
						placed.array[player.x][newIndex].y = placed.array[player.x][newIndex - 1].y+1;
						placed.array[player.x][newIndex].boxType = 1;
					}
				}
				
				break;
			
			default:
				break;
		}
	}
}	

	


function updateBullets() {

	for(i=0; i<bullets.index; i++) {
		bullets.array[i].x += bullets.array[i].dirX*4 + Math.random()/5;
		bullets.array[i].y += bullets.array[i].dirY*4 + Math.random()/10;
		
	}
}

function triggerResponseDraw() {
	if (trigger.response) {
		switch(trigger.type) {
		
			case 1: //cutscene character communication
				drawAlertMessage(ctx);
				break;
			
			default:
				break;
		}
	
	}

}


function mainLoop() {

	updateVertVel();
	updateHorizPos();
	playerGravity();
	
	playerShoot();
	

	ctx.clearRect(0,0,game.frameWidth,game.frameHeight);
	drawBackground(ctx);
	drawGround(ctx);
	drawPlaced(ctx);
	drawPlayer(ctx);
	
	
	if (bullets.index) {
		updateBullets();
		drawBullets(ctx);
	}
	
	
	//Debug output 
	document.getElementById('status').innerHTML = player.fuel;

	if (player.x == 10) {
		trigger.response = true;
		trigger.type = 1;
	}
	else {
		trigger.response = false;
	}
	triggerResponseDraw();
		
		
	setTimeout(mainLoop,50);
}



//Start initialization when the page loads
window.onload = init;
</script>

<style type="text/css">


</style>

<body onkeydown="keyDown(event);" onkeyup="keyUp(event);" onmousedown="mouseDown(event);" onmouseup="mouseUp(event);" onmousemove="mouseMove(event);">


<canvas id="blah" width="800px" height="600px" style="border:1px solid black;"></canvas>

<div id="status">p</div>















</body>
</html>
<!DOCTYPE html>
<html>
<head>
<title>Test</title>
</head>

<script type="text/javascript">


function init() {

	//Initialize Images
	imageObj = new Image();
	imageObj.src = 'ab.png';
	
	imageObj2 = new Image();
	imageObj2.src = 'abL.png';

	imageObj3 = new Image();
	imageObj3.src = 'ab2.png';
	
	imageObj4 = new Image();
	imageObj4.src = 'abL2.png';
	
	
	//Initialize Canvas
	c = document.getElementById("blah");
	ctx = c.getContext("2d");
	
	unicode = 0;
	
	//Initialize Game vars
	game = new Object();
	game.tileSize = 10;
	
		//Initialize ground
		game.ground = new Array();
		game.groundIndex = 0;
		
		game.ground[-1] = new Array(50, 50, 50, 49, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 47, 46, 45, 45, 47, 47, 47, 47, 47, 48, 47, 47, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 49, 48, 48, 48, 48, 48, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 46, 45, 45, 48, 44, 43, 42, 41, 40, 38, 37, 36, 35, 35, 32, 31, 29, 27, 26, 30, 34, 35);
		game.ground[0] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[1] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[2] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[3] = new Array(18, 18, 18, 17, 17, 49, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[4] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[5] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[6] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[7] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[8] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[9] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[10] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[11] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[12] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[13] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[14] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[15] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[16] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[17] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[18] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[19] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		game.ground[20] = new Array(18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 18);
		
	//Initialize Player
	player = new Object();
	player.speed = 1;
	
	//true = right, false = left
	player.direction = true;
	player.walkPattern = true;
	
	
	player.vVel = 0;
	player.x = 0;
	player.y = game.ground[0][0]+1;
	player.width = 1;
	player.height = 3;

	player.fireX = 0;
	player.fireY = 0;
	player.fireToggle = 0;
	
	//Initialize bullets
	bullets = new Object();
	bullets.index = 0;
	bullets.array = new Array();
	
	//Initialize Keys
	keys = new Object();
	
	//initialize mouse
	mouse = new Object();
	
	//Start main loop
	mainLoop();
}

function keyDown(e) {

			//var unicode=e.keyCode? e.keyCode : e.charCode
			if (e.keyCode) {var unicode = e.keyCode}
			//if (e.charCode) {var unicode = e.charCode}

			if (unicode == 87) {keys.up = 1;}
			if (unicode == 65) {keys.left = 1;}
			if (unicode == 83) {keys.down = 1;}
			if (unicode == 68) {keys.right = 1;}
			if (unicode == 32) {keys.space = 1;}
			if (unicode == 16) {keys.shift = 1;}

}

function keyUp(e) {

			//var unicode=e.keyCode? e.keyCode : e.charCode
			if (e.keyCode) {var unicode = e.keyCode}
			//if (e.charCode) {var unicode = e.charCode}

			if (unicode == 87) {keys.up = 0;}
			if (unicode == 65) {keys.left = 0;}
			if (unicode == 83) {keys.down = 0;}
			if (unicode == 68) {keys.right = 0;}
			if (unicode == 32) {keys.space = 0;}
			if (unicode == 16) {keys.shift = 0;}
}

		//		    87 W
		//	65 A	83 S	68 D

		
function mouseDown(e) {

			player.fireToggle = 1;
		
			var xOffset=Math.max(document.documentElement.scrollLeft,document.body.scrollLeft);
			var yOffset=Math.max(document.documentElement.scrollTop,document.body.scrollTop);

			mouse.x = e.clientX + xOffset - c.offsetLeft;
			mouse.y = e.clientY + yOffset - c.offsetTop;
			
			player.fireX = Math.floor(mouse.x/game.tileSize);
			player.fireY = 600/game.tileSize - Math.floor(mouse.y/game.tileSize);

}

function mouseUp(e) {

			player.fireToggle = 0;

			mouse.x = 0;
			mouse.y = 0;
			
			player.fireX = 0;
			player.fireY = 0;
			

}		

function mouseMove(e) {
	if (player.fireToggle == 1) {
		mouseDown(e);
	}
}

function updateHorizPos() {

	
	
	if (keys.left == 1) {
		if (player.walkPattern == 4) {
			player.walkPattern = 0;
		} else {
			player.walkPattern++;
		}
		collisionDetectLeft();
	}
	if (keys.right == 1) {
		if (player.walkPattern == 4) {
			player.walkPattern = 0;
		} else {
			player.walkPattern++;
		}
		collisionDetectRight();
	}
}
	
function updateVertVel() {
	if (keys.up == 1 && (player.y - game.ground[game.groundIndex][player.x] <= 1.1)) {
		player.vVel = 3;
	}
	if (keys.down == 1) {
		player.height = 3;
		game.ground[game.groundIndex][player.x] -= 1;
	}
	else {
		player.height = 3;

	}
	
	if (keys.shift == 1) {
		
		game.ground[game.groundIndex][player.x] += 1;
	}
	
	if (keys.space == 1) {
		if (player.vVel < 3) {
			player.vVel=player.vVel+1;
		}
	}
	
}
		

function collisionDetectRight() {

	player.direction = true;

	
	for (i=player.x; i < player.x+40; i++) {
		if (player.y < game.ground[game.groundIndex][i]) {
			break;
		}
		
		if (player.x == 79 && player.y < game.ground[game.groundIndex+1][0]) {
			break;
		}
	}
	
	if (i-player.x > 1) {
		player.x = player.x + 1;
		if (player.x == 80) {
			player.x = 0;
			game.groundIndex++;
		}
	}
}

function collisionDetectLeft() {

	player.direction = false;

	
	for (i=player.x; i > player.x-40; i--) {
		if (player.y < game.ground[game.groundIndex][i]) {
			break;
		}
		
		if (player.x == 0 && player.y < game.ground[game.groundIndex-1][79]) {
			break;
		}
	}
	
	if (player.x-i > 1) {
		player.x = player.x - 1;
		if (player.x == -1) {
			player.x = 79;
			game.groundIndex--;
		}
	}
}
		
function playerGravity() {

	if (player.vVel != 0 || ( (player.y - game.ground[game.groundIndex][player.x]) > 1) ) {
	
		if (player.vVel == 0 && (player.y <= game.ground[game.groundIndex][player.x-1]+1) ) {
			player.y = player.y - 1.1;
			
		} else {
		
			player.y = player.y + Math.round(player.vVel);	
		}
		player.vVel = player.vVel - 0.5;
		
		if ((player.y - game.ground[game.groundIndex][player.x]) <= 1) {
			player.vVel = 0;
			player.y = game.ground[game.groundIndex][player.x] + 1;
		}
	

	} else if (Math.floor(player.y) <= game.ground[game.groundIndex][player.x]) {
			player.y = game.ground[game.groundIndex][player.x] + 1;
		
	}
}


function playerShoot() {
	
	if (player.fireX != 0) {
		
		//THIS IS THE LAKE
		bullets.array[bullets.index] = new Object();
		bullets.array[bullets.index].x = player.x;
		bullets.array[bullets.index].y = player.y + player.height - 2;
		
		var dirX = player.fireX - 40;
		var dirY = player.fireY - 30 - player.height;
		var dirT = Math.sqrt(dirX*dirX + dirY*dirY);
		
		bullets.array[bullets.index].dirX = dirX/dirT;
		bullets.array[bullets.index].dirY = dirY/dirT;
		
		bullets.index++;
	}
}	

	
function drawPlayer(context) {

		context.beginPath();
		//context.rect(player.x*game.tileSize, 600-10*player.height-player.y*game.tileSize, player.width*game.tileSize, player.height*game.tileSize);
		context.rect(40*game.tileSize, 600-10*player.height-30*game.tileSize, player.width*game.tileSize, player.height*game.tileSize);
		context.fillStyle = 'blue';
		context.fill();

		
		//if (player.direction) {
		//	if (player.walkPattern > 2) {
		//		context.drawImage(imageObj, 40*game.tileSize, 600-10*player.height-30*game.tileSize);
		//	} else {
		//		context.drawImage(imageObj3, 40*game.tileSize, 600-10*player.height-30*game.tileSize);
		//	}
		//} else {
		//	if (player.walkPattern > 2) {
		//		context.drawImage(imageObj2, 40*game.tileSize, 600-10*player.height-30*game.tileSize);
		//	} else {
		//		context.drawImage(imageObj4, 40*game.tileSize, 600-10*player.height-30*game.tileSize);
		//	}
		//}
}

function updateBullets() {

	for(i=0; i<bullets.index; i++) {
		bullets.array[i].x += bullets.array[i].dirX*1.5 + Math.random()/5;
		bullets.array[i].y += bullets.array[i].dirY*1.5 //+ Math.random()/10;
		
	}
}



function randoGrow() {
	i = 2*Math.random()+1;
	player.width = i;
}

function drawGround(context) {

	context.beginPath();
	
	context.moveTo(0,600);
	var n = 0;
	for (i=player.x-40;i<player.x+41;i++) {
		
		if (i < 0) {
		
			var blockY =  590 - (game.ground[game.groundIndex-1][i+80]-player.y+30)*game.tileSize; //590-game.ground[0][i]*game.tileSize;
			var blockX = n*game.tileSize; //i*game.tileSize;
			
			context.lineTo(blockX + 0.3*game.tileSize, blockY)//, game.tileSize, (game.ground[game.groundIndex-1][i+80]+1)*game.tileSize);
			context.lineTo(blockX + 0.7*game.tileSize, blockY)
			
		} else if (i < 80) {
		
			var blockY =  590 - (game.ground[game.groundIndex][i]-player.y+30)*game.tileSize; //590-game.ground[0][i]*game.tileSize;
			var blockX = n*game.tileSize; //i*game.tileSize;
			context.lineTo(blockX + 0.3*game.tileSize, blockY)//, game.tileSize, (game.ground[game.groundIndex][i]+1)*game.tileSize);
			context.lineTo(blockX + 0.7*game.tileSize, blockY)
			
		} else {
		
			var blockY =  590 - (game.ground[game.groundIndex+1][i-80]-player.y+30)*game.tileSize; //590-game.ground[0][i]*game.tileSize;
			var blockX = n*game.tileSize; //i*game.tileSize;
			context.lineTo(blockX + 0.3*game.tileSize, blockY)//, game.tileSize, (game.ground[game.groundIndex+1][i-80]+1)*game.tileSize);
			context.lineTo(blockX + 0.7*game.tileSize, blockY)
		}

		
		n++;
		
	}
	context.lineTo(800,600);
	context.closePath();
	context.stroke();
	context.fillStyle = 'brown';
	context.fill();
}

function drawBullets(context) {

		for(i=0; i<bullets.index; i++) {
		
		var coordY =  590 - (bullets.array[i].y-player.y+30)*game.tileSize;
		var coordX = (bullets.array[i].x-player.x+40)*game.tileSize;
		
		context.beginPath();
		context.rect(coordX, coordY, game.tileSize/5, game.tileSize/5);
		context.fill();
		
		

		
	}
}

function mainLoop() {

	updateVertVel();
	updateHorizPos();
	playerGravity();
	
	playerShoot();
	
	
	//randoGrow();
	
	ctx.clearRect(0,0,800,600);
	drawGround(ctx);
	drawPlayer(ctx);
	
	if (bullets.index) {
		updateBullets();
		drawBullets(ctx);
	}
	
	
	if (bullets.index > 0) {
		document.getElementById('status').innerHTML = bullets.array[0].x;
		}
	setTimeout(mainLoop,50);
}



//Start initialization when the page loads
window.onload = init;
</script>

<style type="text/css">


</style>

<body onkeydown="keyDown(event);" onkeyup="keyUp(event);" onmousedown="mouseDown(event);" onmouseup="mouseUp(event);" onmousemove="mouseMove(event);">


<canvas id="blah" width="800px" height="600px" style="border:1px solid black;"></canvas>

<div id="status">p</div>















</body>
</html>